{
  "chapter": 20,
  "title": "Macros",
  "fls_url": "https://rust-lang.github.io/fls/macros.html",
  "fls_id": "fls_83182bfa9uqb",
  "repository": "eclipse-iceoryx/iceoryx2",
  "version": "0.8.0",
  "analysis_date": "2025-12-30",
  "version_changes": {
    "from_version": "0.7.0",
    "to_version": "0.8.0",
    "summary": "Logging system restructured to iceoryx2-log crate. New proc-macro crates added for FFI and conformance testing.",
    "key_changes": [
      "Declarative macros: 16 \u2192 28 (+75%)",
      "Procedural macros: 2 \u2192 6 (+200%)",
      "Proc-macro crates: 1 \u2192 3 (derive-macros, ffi-macros, conformance-test-macros)",
      "#[macro_export]: 12 \u2192 20 (+67%)",
      "ZeroCopySend derives: 138 \u2192 166 (+20%)",
      "PlacementDefault derives: 11 \u2192 20 (+82%)",
      "assert_that! invocations: 4,571 \u2192 5,283 (+16%)",
      "Logging macros moved to iceoryx2-log/log/src/log.rs",
      "fail! macro moved to iceoryx2-log/log/src/fail.rs",
      "New CStrRepr derive macro for FFI",
      "New attribute macros: iceoryx2_crate, implement_conformance_test"
    ]
  },
  "summary": "FLS Chapter 20 covers declarative macros (macro_rules!), procedural macros (derive, attribute, function-like), macro invocation, expansion, and hygiene. iceoryx2 v0.8.0 defines 28 declarative macros and 6 procedural macros across 3 proc-macro crates (PlacementDefault, ZeroCopySend, CStrRepr derives; iceoryx2_crate, implement_conformance_test attributes). The logging system was restructured to iceoryx2-log with fail!, trace!, debug!, info!, warn!, error!, and fatal_panic! macros. All public macros use #[macro_export(local_inner_macros)] and $crate for proper hygiene.",
  "statistics": {
    "declarative_macros_defined": 28,
    "procedural_macros_defined": 6,
    "proc_macro_derive": 3,
    "proc_macro_attribute": 3,
    "proc_macro_function": 0,
    "proc_macro_crates": 3,
    "macro_export_count": 20,
    "crate_metavariable_usage": 24,
    "fail_imports": 131,
    "enum_gen_invocations": 63,
    "semantic_string_invocations": 11,
    "placement_default_derives": 20,
    "zero_copy_send_derives": 166,
    "assert_that_invocations": 5283
  },
  "sections": {
    "declarative_macros": {
      "fls_section": "20.1",
      "fls_ids": [
        "fls_xa7lp0zg1ol2"
      ],
      "description": "Declarative Macros",
      "status": "demonstrated",
      "findings": {
        "declarative_macros": {
          "section": "20.1",
          "count": 28,
          "categories": {
            "logging": {
              "location": "iceoryx2-log/log/src/",
              "macros": [
                {
                  "name": "fail!",
                  "file": "iceoryx2-log/log/src/fail.rs",
                  "line": 55,
                  "exported": true,
                  "purpose": "Combines error handling with logging - fails and returns error with debug message"
                },
                {
                  "name": "trace!",
                  "file": "iceoryx2-log/log/src/log.rs",
                  "line": 39,
                  "exported": true,
                  "purpose": "Logs trace-level messages"
                },
                {
                  "name": "debug!",
                  "file": "iceoryx2-log/log/src/log.rs",
                  "line": 80,
                  "exported": true,
                  "purpose": "Logs debug-level messages"
                },
                {
                  "name": "info!",
                  "file": "iceoryx2-log/log/src/log.rs",
                  "line": 121,
                  "exported": true,
                  "purpose": "Logs info-level messages"
                },
                {
                  "name": "warn!",
                  "file": "iceoryx2-log/log/src/log.rs",
                  "line": 162,
                  "exported": true,
                  "purpose": "Logs warning-level messages"
                },
                {
                  "name": "error!",
                  "file": "iceoryx2-log/log/src/log.rs",
                  "line": 203,
                  "exported": true,
                  "purpose": "Logs error-level messages"
                },
                {
                  "name": "fatal_panic!",
                  "file": "iceoryx2-log/log/src/log.rs",
                  "line": 244,
                  "exported": true,
                  "purpose": "Logs fatal message then panics - for invariant violations"
                },
                {
                  "name": "cout!",
                  "file": "iceoryx2-log/log/src/lib.rs",
                  "line": 276,
                  "exported": true,
                  "purpose": "Writes to stdout"
                },
                {
                  "name": "cerr!",
                  "file": "iceoryx2-log/log/src/lib.rs",
                  "line": 283,
                  "exported": true,
                  "purpose": "Writes to stderr"
                }
              ]
            },
            "code_generation": {
              "macros": [
                {
                  "name": "enum_gen!",
                  "file": "iceoryx2-bb/elementary/src/enum_gen.rs",
                  "line": 172,
                  "invocations": 63,
                  "exported": true,
                  "purpose": "Generates error enums with automatic From implementations"
                },
                {
                  "name": "semantic_string!",
                  "file": "iceoryx2-bb/container/src/semantic_string.rs",
                  "line": 389,
                  "invocations": 11,
                  "exported": true,
                  "purpose": "Generates semantic string types with validation"
                },
                {
                  "name": "generate_id!",
                  "file": "iceoryx2/src/port/port_identifiers.rs",
                  "line": 20,
                  "exported": false,
                  "purpose": "Generates port identifier types"
                }
              ]
            },
            "platform": {
              "macros": [
                {
                  "name": "win32call!",
                  "file": "iceoryx2-pal/posix/src/windows/win32_call.rs",
                  "line": 100,
                  "exported": true,
                  "purpose": "Windows API call wrapper with error handling"
                },
                {
                  "name": "handle_errno!",
                  "file": "iceoryx2-bb/posix/src/handle_errno.rs",
                  "line": 17,
                  "exported": true,
                  "purpose": "Maps errno values to error enums"
                },
                {
                  "name": "define_signals!",
                  "file": "iceoryx2-bb/posix/src/signal.rs",
                  "line": 85,
                  "exported": false,
                  "purpose": "Defines signal constants"
                },
                {
                  "name": "ErrnoEnumGenerator!",
                  "file": "iceoryx2-pal/posix/src/common/error_enum_generator.rs",
                  "line": 14,
                  "exported": true,
                  "purpose": "Generates errno enums for POSIX compatibility"
                }
              ]
            },
            "testing": {
              "macros": [
                {
                  "name": "assert_that!",
                  "file": "iceoryx2-pal/testing/src/assert.rs",
                  "line": 14,
                  "invocations": 5283,
                  "exported": true,
                  "purpose": "Fluent assertion macro for testing"
                },
                {
                  "name": "test_requires!",
                  "file": "iceoryx2-pal/testing/src/lib.rs",
                  "line": 25,
                  "exported": true,
                  "purpose": "Conditional test execution"
                },
                {
                  "name": "test_fail!",
                  "file": "iceoryx2-pal/testing/src/lib.rs",
                  "line": 32,
                  "exported": true,
                  "purpose": "Test failure macro"
                },
                {
                  "name": "instantiate_conformance_tests!",
                  "file": "iceoryx2-bb/testing/src/instantiate_conformance_tests_macro.rs",
                  "line": 31,
                  "exported": true,
                  "purpose": "Instantiates conformance test suites"
                }
              ]
            },
            "internal_helpers": {
              "macros": [
                {
                  "name": "Impl!",
                  "file": "iceoryx2-bb/concurrency/src/atomic.rs",
                  "line": 65,
                  "purpose": "Helper for atomic type implementations"
                },
                {
                  "name": "Impl!",
                  "file": "iceoryx2-bb/elementary-traits/src/placement_default.rs",
                  "line": 65,
                  "purpose": "Helper for PlacementDefault implementations"
                },
                {
                  "name": "add_to_ace_string!",
                  "file": "iceoryx2-pal/posix/src/windows/win32_security_attributes.rs",
                  "line": 113,
                  "purpose": "Builds Windows ACE strings"
                }
              ]
            }
          }
        },
        "metavariables": {
          "section": "20.1.1",
          "fragment_specifiers_used": {
            "expr": "Expression matching - used in logging and fail macros",
            "ident": "Identifier matching - used in enum and type generation",
            "meta": "Attribute meta matching - used in documentation",
            "ty": "Type matching - used in generic macros",
            "tt": "Token tree matching - used for flexible patterns"
          }
        },
        "repetition": {
          "section": "20.1.2",
          "operators_used": {
            "*": "Zero or more - used in logging macros for variadic messages",
            "+": "One or more - used in enum_gen for entries",
            "?": "Optional - used for optional errno suffixes"
          }
        }
      },
      "samples": [],
      "subsections": {
        "metavariables": {
          "fls_section": "20.1.1",
          "fls_ids": [
            "fls_8nzypdu9j3ge"
          ],
          "description": "Metavariables",
          "status": "demonstrated",
          "findings": {
            "description": "Metavariables ($ident, $expr, $ty, etc.) used in 20 files across iceoryx2 macro definitions.",
            "common_types": [
              "$ident",
              "$expr",
              "$ty",
              "$tt",
              "$literal"
            ],
            "example_files": [
              "iceoryx2-log/log/src/log.rs",
              "iceoryx2-bb/elementary/src/enum_gen.rs"
            ]
          },
          "samples": []
        },
        "repetition": {
          "fls_section": "20.1.2",
          "fls_ids": [
            "fls_k01lsksqtq1r"
          ],
          "description": "Repetition",
          "status": "demonstrated",
          "findings": {
            "description": "Repetition operators ($(...)*) used extensively for variadic macro arguments.",
            "usage": "Logging macros, enum_gen!, semantic_string! all use repetition for flexible argument handling."
          },
          "samples": []
        }
      }
    },
    "procedural_macros": {
      "fls_section": "20.2",
      "fls_ids": [
        "fls_wn1i6hzg2ff7"
      ],
      "description": "Procedural Macros",
      "status": "demonstrated",
      "findings": {
        "procedural_macros": {
          "section": "20.2",
          "crates": {
            "iceoryx2-bb/derive-macros": {
              "macros": [
                {
                  "name": "PlacementDefault",
                  "type": "derive",
                  "file": "iceoryx2-bb/derive-macros/src/lib.rs",
                  "line": 56,
                  "invocations": 20,
                  "purpose": "Generates PlacementDefault trait impl for in-place initialization",
                  "description": "Recursively calls PlacementDefault::placement_default on each field"
                },
                {
                  "name": "ZeroCopySend",
                  "type": "derive",
                  "file": "iceoryx2-bb/derive-macros/src/lib.rs",
                  "line": 156,
                  "invocations": 166,
                  "purpose": "Marks types as safe for IPC/shared memory transfer",
                  "helper_attributes": [
                    "type_name"
                  ]
                }
              ]
            },
            "iceoryx2-ffi/ffi-macros": {
              "description": "NEW in v0.8.0 - FFI macro support",
              "macros": [
                {
                  "name": "iceoryx2_crate",
                  "type": "attribute",
                  "file": "iceoryx2-ffi/ffi-macros/src/lib.rs",
                  "line": 25,
                  "purpose": "Marks FFI crate entry points"
                },
                {
                  "name": "CStrRepr",
                  "type": "derive",
                  "file": "iceoryx2-ffi/ffi-macros/src/lib.rs",
                  "line": 251,
                  "purpose": "Generates C string representation for FFI enums",
                  "helper_attributes": [
                    "CStr"
                  ]
                }
              ]
            },
            "iceoryx2-bb/conformance-test-macros": {
              "description": "NEW in v0.8.0 - Conformance testing macros",
              "macros": [
                {
                  "name": "implement_conformance_test",
                  "type": "attribute",
                  "file": "iceoryx2-bb/conformance-test-macros/src/lib.rs",
                  "line": 35,
                  "purpose": "Marks functions as conformance tests"
                },
                {
                  "name": "generate_conformance_test_macro",
                  "type": "attribute",
                  "file": "iceoryx2-bb/conformance-test-macros/src/lib.rs",
                  "line": 48,
                  "purpose": "Generates conformance test macro invocations"
                }
              ]
            }
          },
          "dependencies": [
            "proc_macro",
            "quote",
            "syn"
          ]
        }
      },
      "samples": [],
      "subsections": {
        "functionlike_macros": {
          "fls_section": "20.2.1",
          "fls_ids": [
            "fls_2d6bqnpy6tvs"
          ],
          "description": "Function-like Macros",
          "status": "not_used",
          "findings": {
            "description": "No function-like procedural macros (#[proc_macro]) defined in iceoryx2. All proc macros are derive or attribute macros.",
            "count": 0
          },
          "samples": []
        },
        "derive_macros": {
          "fls_section": "20.2.2",
          "fls_ids": [
            "fls_o8s3r7m90q59"
          ],
          "description": "Derive Macros",
          "status": "demonstrated",
          "findings": {
            "description": "Three derive macros defined: PlacementDefault, ZeroCopySend (iceoryx2-bb/derive-macros), CStrRepr (iceoryx2-ffi/ffi-macros).",
            "count": 3,
            "macros": [
              "PlacementDefault",
              "ZeroCopySend",
              "CStrRepr"
            ]
          },
          "samples": [
            {
              "file": "iceoryx2-bb/derive-macros/src/lib.rs",
              "line": [
                10
              ],
              "code": "#[proc_macro_derive(PlacementDefault)]",
              "purpose": "Derive macro for in-place default initialization"
            }
          ]
        },
        "attribute_macros": {
          "fls_section": "20.2.3",
          "fls_ids": [
            "fls_4vjbkm4ceymk"
          ],
          "description": "Attribute Macros",
          "status": "demonstrated",
          "findings": {
            "description": "Three attribute macros: conformance_test, conformance_test_module (conformance-test-macros), iceoryx2_ffi (ffi-macros).",
            "count": 3,
            "macros": [
              "conformance_test",
              "conformance_test_module",
              "iceoryx2_ffi"
            ]
          },
          "samples": [
            {
              "file": "iceoryx2-bb/conformance-test-macros/src/lib.rs",
              "line": [
                5
              ],
              "code": "#[proc_macro_attribute]",
              "purpose": "Attribute macro for conformance testing"
            }
          ]
        }
      }
    },
    "macro_invocation": {
      "fls_section": "20.3",
      "fls_ids": [
        "fls_vnvt40pa48n8"
      ],
      "description": "Macro Invocation",
      "status": "demonstrated",
      "findings": {
        "macro_invocation": {
          "section": "20.3",
          "high_frequency_custom": {
            "assert_that!": 5283,
            "fail!": 131,
            "enum_gen!": 63,
            "semantic_string!": 11
          },
          "derive_invocations": {
            "ZeroCopySend": 166,
            "PlacementDefault": 20
          }
        }
      },
      "samples": []
    },
    "hygiene": {
      "fls_section": "20.5",
      "fls_ids": [
        "fls_xlfo7di0gsqz"
      ],
      "description": "Hygiene",
      "status": "demonstrated",
      "findings": {
        "hygiene": {
          "section": "20.5",
          "crate_metavariable": {
            "usage_count": 24,
            "purpose": "Refers to the crate the macro was defined in",
            "sample": "$crate::__internal_print_log_msg($crate::LogLevel::Trace, ...)"
          },
          "local_inner_macros": {
            "usage_count": 20,
            "purpose": "Allows exported macros to call other macros from the same crate",
            "pattern": "#[macro_export(local_inner_macros)]"
          }
        }
      },
      "samples": []
    },
    "macro_expansion": {
      "fls_section": "20.4",
      "fls_ids": [
        "fls_wjldgtio5o75"
      ],
      "description": "Macro Expansion",
      "status": "demonstrated",
      "findings": {
        "description": "Macro expansion is the process of replacing a macro invocation with the result of the macro. In iceoryx2, declarative macros expand to Rust code while procedural macros generate TokenStreams.",
        "expansion_patterns": {
          "declarative": "macro_rules! macros expand via pattern matching and substitution",
          "derive": "Derive macros generate impl blocks for traits",
          "attribute": "Attribute macros transform annotated items"
        },
        "notable_expansions": {
          "enum_gen": "Expands to enum definition with From implementations for each entry",
          "semantic_string": "Expands to struct with validation, normalization, and trait implementations",
          "fail": "Expands to conditional check, log call, and early return with error"
        },
        "recursive_expansion": "Declarative macros use #[macro_export(local_inner_macros)] to enable recursive calls"
      },
      "samples": [
        {
          "file": "iceoryx2-bb/elementary/src/enum_gen.rs",
          "line": [
            172
          ],
          "code": "macro_rules! enum_gen { ... }",
          "purpose": "Generates error enums with automatic From implementations"
        }
      ],
      "subsections": {
        "macro_matching": {
          "fls_section": "20.4.1",
          "fls_ids": [
            "fls_4apk1exafxii"
          ],
          "description": "Macro Matching",
          "status": "demonstrated",
          "findings": {
            "description": "Macro matching is used by all 28 declarative macros. Pattern matching in macro_rules! is the foundation of macro expansion."
          },
          "samples": [],
          "subsections": {
            "rule_matching": {
              "fls_section": "20.4.1.1",
              "fls_ids": [
                "fls_n3ktmjqf87qb"
              ],
              "description": "Rule Matching",
              "status": "demonstrated",
              "findings": {
                "description": "Multi-rule macros use rule matching to select the appropriate expansion. enum_gen! and logging macros have multiple rules."
              },
              "samples": []
            },
            "token_matching": {
              "fls_section": "20.4.1.2",
              "fls_ids": [
                "fls_qpx6lgapce57"
              ],
              "description": "Token Matching",
              "status": "demonstrated",
              "findings": {
                "description": "Token matching occurs during macro invocation. All macro_rules! macros use token matching for pattern recognition."
              },
              "samples": []
            }
          }
        },
        "macro_transcription": {
          "fls_section": "20.4.2",
          "fls_ids": [
            "fls_ym00b6ewf4n3"
          ],
          "description": "Macro Transcription",
          "status": "demonstrated",
          "findings": {
            "description": "Macro transcription produces the expanded code. All declarative macros transcribe their matched patterns into Rust code."
          },
          "samples": []
        }
      }
    }
  },
  "design_patterns": {
    "error_handling_with_logging": {
      "description": "fail! macro combines Result error handling with debug logging",
      "benefit": "Single macro call handles check, log, and return"
    },
    "enum_composition": {
      "description": "enum_gen! generates error enums with From implementations",
      "benefit": "Automatic error type composition and propagation"
    },
    "semantic_string_generation": {
      "description": "semantic_string! generates validated string types",
      "benefit": "Type-safe strings with validation, normalization, and serde support"
    },
    "derive_for_ipc": {
      "description": "PlacementDefault and ZeroCopySend derive macros for IPC types",
      "benefit": "Safe shared memory initialization and transfer"
    },
    "derive_for_ffi": {
      "description": "NEW - CStrRepr derive macro for FFI C string representation",
      "benefit": "Automatic C-compatible string generation for enums"
    },
    "conformance_testing": {
      "description": "NEW - Attribute macros for conformance test generation",
      "benefit": "Standardized testing infrastructure across trait implementations"
    },
    "hygiene_through_crate": {
      "description": "All exported macros use $crate and local_inner_macros",
      "benefit": "Proper hygiene when macros call other macros"
    }
  },
  "cross_chapter_references": {
    "chapter_13": "Attributes - #[macro_export], #[proc_macro_derive], #[proc_macro_attribute]",
    "chapter_18": "Program Structure - proc-macro crate type",
    "chapter_19": "Unsafety - ZeroCopySend unsafe trait derived by macro",
    "chapter_21": "FFI - CStrRepr derive for C-compatible enums"
  }
}