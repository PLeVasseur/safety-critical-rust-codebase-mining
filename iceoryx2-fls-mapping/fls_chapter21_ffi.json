{
  "chapter": 21,
  "title": "FFI",
  "fls_url": "https://rust-lang.github.io/fls/ffi.html",
  "fls_id": "fls_osd6c4utyjb3",
  "repository": "eclipse-iceoryx/iceoryx2",
  "version": "0.8.0",
  "analysis_date": "2025-12-30",
  "version_changes": {
    "from_version": "0.7.0",
    "to_version": "0.8.0",
    "summary": "MASSIVE FFI expansion - new iceoryx2-ffi/c crate provides complete C API with 585 #[no_mangle] functions, 42 union types, and comprehensive type bindings.",
    "key_changes": [
      "extern C fn: 17 \u2192 630 (+3606%)",
      "#[no_mangle]: ~0 \u2192 602 (NEW - C API exports)",
      "#[repr(C)]: 160 \u2192 393 (+146%)",
      "union types: 0 \u2192 42 (NEW - FFI discriminated unions)",
      "New crate: iceoryx2-ffi/c with 83 API modules",
      "New crate: iceoryx2-ffi/ffi-macros with iceoryx2_ffi attribute",
      "New crate: iceoryx2-ffi/python for Python bindings",
      "iceoryx2_ffi macro invocations: 56 (generates FFI boilerplate)",
      "CStrRepr derive macro for C string representation",
      "ManuallyDrop used extensively for union variant lifetimes"
    ]
  },
  "summary": "FLS Chapter 21 covers Foreign Function Interface including ABI, external blocks, external functions, and external statics. iceoryx2 v0.8.0 demonstrates MASSIVE FFI expansion with the new iceoryx2-ffi/c crate providing a complete C API: 630 extern C functions, 602 #[no_mangle] exports, 393 #[repr(C)] types, and 42 union types for IPC/Local service variants. The Platform Abstraction Layer (iceoryx2-pal-posix) continues to provide POSIX APIs across 5 platforms. New ffi-macros crate with iceoryx2_ffi attribute and CStrRepr derive simplify FFI boilerplate generation.",
  "statistics": {
    "extern_c_fn": 630,
    "extern_system_usage": 2,
    "extern_c_blocks": 11,
    "no_mangle_attribute": 602,
    "no_mangle_in_ffi_c": 585,
    "repr_c_types": 393,
    "union_types": 42,
    "link_attribute": 1,
    "link_name_attribute": 4,
    "export_name_attribute": 0,
    "ffi_api_modules": 83,
    "iceoryx2_ffi_invocations": 56,
    "platforms_supported": 5,
    "platform_modules": 27
  },
  "sections": {
    "abi": {
      "fls_section": "21.1",
      "fls_ids": [
        "fls_usgd0xlijoxv"
      ],
      "description": "ABI",
      "status": "demonstrated",
      "findings": {
        "abi_usage": {
          "section": "21.1",
          "extern_c": {
            "count": 630,
            "purposes": [
              "C API export functions (#[no_mangle] extern \"C\" fn)",
              "External blocks for POSIX function declarations",
              "Callback functions for threads and signals",
              "Function pointer types for C compatibility"
            ]
          },
          "extern_system": {
            "count": 2,
            "purpose": "Windows-specific callbacks using Windows calling convention"
          }
        },
        "repr_c_types": {
          "count": 393,
          "change": "+146% from v0.7.0",
          "categories": {
            "ffi_c_api": {
              "count": 200,
              "purpose": "C API types for language bindings"
            },
            "shared_memory": {
              "count": 100,
              "purpose": "IPC types with stable memory layout"
            },
            "containers": {
              "count": 50,
              "purpose": "Container types for shared memory"
            },
            "posix_bindings": {
              "count": 43,
              "purpose": "POSIX type compatibility"
            }
          }
        },
        "union_types": {
          "count": 42,
          "purpose": "Discriminated unions for IPC/Local service variants in C API",
          "pattern": "Each union contains ipc/local variants wrapped in ManuallyDrop",
          "destruction_pattern": "ManuallyDrop::drop() called explicitly in iox2_*_drop functions"
        }
      },
      "samples": [
        {
          "file": "iceoryx2-ffi/c/src/api/publisher.rs",
          "line": [95, 96, 97, 98],
          "code": "pub(super) union PublisherUnion {\n    ipc: ManuallyDrop<Publisher<crate::IpcService, PayloadFfi, UserHeaderFfi>>,\n    local: ManuallyDrop<Publisher<crate::LocalService, PayloadFfi, UserHeaderFfi>>,\n}",
          "purpose": "FFI union with ManuallyDrop variants for IPC/Local publisher type erasure"
        },
        {
          "file": "iceoryx2-ffi/c/src/api/reader.rs",
          "line": [148, 149, 150, 151, 152],
          "code": "#[no_mangle]\npub unsafe extern \"C\" fn iox2_entry_handle_error_string(\n    error: iox2_entry_handle_error_e,\n) -> *const c_char {\n    error.as_const_cstr().as_ptr() as *const c_char",
          "purpose": "Exported C function converting error enum to C string for FFI consumers"
        },
        {
          "file": "iceoryx2-pal/posix/src/linux/select.rs",
          "line": [67, 68, 69, 70, 71, 72],
          "code": "#[cfg_attr(target_os = \"linux\", link(name = \"c\"))]\nextern \"C\" {\n    pub(super) fn iceoryx2_cmsg_space(len: size_t) -> size_t;\n    pub(super) fn iceoryx2_cmsg_firsthdr(hdr: *const msghdr) -> *mut cmsghdr;\n    pub(super) fn iceoryx2_cmsg_nxthdr(hdr: *mut msghdr, sub: *mut cmsghdr) -> *mut cmsghdr;",
          "purpose": "Extern block binding custom C helper functions for CMSG operations"
        }
      ],
      "count": 652
    },
    "external_functions": {
      "fls_section": "21.3",
      "fls_ids": [
        "fls_yztwtek0y34v"
      ],
      "description": "External Functions",
      "status": "demonstrated",
      "findings": {
        "ffi_c_crate": {
          "crate": "iceoryx2-ffi/c",
          "description": "NEW in v0.8.0 - Complete C language API for iceoryx2",
          "modules": 83,
          "statistics": {
            "no_mangle_functions": 585,
            "extern_c_functions": 600,
            "union_types": 42,
            "repr_c_types": 200
          },
          "api_categories": {
            "core_types": [
              "node.rs - Node creation and management",
              "service.rs - Service discovery and creation",
              "config.rs - Configuration management"
            ],
            "messaging": [
              "publisher.rs - Publish-subscribe publisher",
              "subscriber.rs - Publish-subscribe subscriber",
              "sample.rs - Sample handling",
              "sample_mut.rs - Mutable sample handling"
            ],
            "events": [
              "notifier.rs - Event notification",
              "listener.rs - Event listening",
              "waitset.rs - Wait set management"
            ],
            "request_response": [
              "client.rs - Request-response client",
              "server.rs - Request-response server",
              "request_mut.rs - Request handling",
              "response.rs - Response handling"
            ],
            "identifiers": [
              "unique_publisher_id.rs",
              "unique_subscriber_id.rs",
              "unique_notifier_id.rs",
              "unique_listener_id.rs",
              "unique_client_id.rs",
              "unique_server_id.rs"
            ],
            "builders": [
              "service_builder.rs",
              "port_factory_*.rs (8 modules)"
            ]
          },
          "naming_convention": {
            "types": "iox2_*_t (handles), iox2_*_h (pointers), iox2_*_e (enums)",
            "functions": "iox2_*_new, iox2_*_drop, iox2_*_<operation>",
            "samples": [
              "iox2_publisher_t - Publisher handle type",
              "iox2_publisher_h - Publisher pointer",
              "iox2_send_error_e - Send error enum"
            ]
          }
        },
        "ffi_macros_crate": {
          "crate": "iceoryx2-ffi/ffi-macros",
          "description": "NEW in v0.8.0 - Procedural macros for FFI boilerplate generation",
          "macros": {
            "iceoryx2_ffi": {
              "type": "attribute",
              "invocations": 56,
              "purpose": "Generates FFI type wrappers and conversion boilerplate",
              "sample": "#[iceoryx2_ffi(ServiceName)]"
            },
            "CStrRepr": {
              "type": "derive",
              "purpose": "Generates C string representation for enums",
              "sample": "#[derive(CStrRepr)]"
            }
          }
        },
        "python_bindings": {
          "crate": "iceoryx2-ffi/python",
          "description": "NEW in v0.8.0 - Python language bindings",
          "implementation": "Uses pyo3 for Python FFI"
        },
        "c_api_error_handling": {
          "pattern": "Functions return c_int with IOX2_OK (0) for success",
          "error_enums": {
            "naming": "iox2_*_error_e",
            "samples": [
              "iox2_send_error_e",
              "iox2_loan_error_e",
              "iox2_receive_error_e"
            ]
          },
          "trait": "IntoCInt for Rust error to C error code conversion"
        },
        "no_mangle_functions": {
          "count": 602,
          "distribution": {
            "iceoryx2-ffi/c": 585,
            "other_crates": 17
          },
          "sample": {
            "file": "iceoryx2-ffi/c/src/api/publisher.rs",
            "code": "#[no_mangle] pub unsafe extern \"C\" fn iox2_publisher_send(...) -> c_int"
          }
        }
      },
      "samples": [
        {
          "file": "iceoryx2-ffi/c/src/api/reader.rs",
          "line": [148, 149, 150, 151, 152, 153],
          "code": "#[no_mangle]\npub unsafe extern \"C\" fn iox2_entry_handle_error_string(\n    error: iox2_entry_handle_error_e,\n) -> *const c_char {\n    error.as_const_cstr().as_ptr() as *const c_char\n}",
          "purpose": "No-mangle extern C function exported for C language bindings"
        },
        {
          "file": "iceoryx2-bb/posix/src/thread.rs",
          "line": [461, 462, 463, 464, 465],
          "code": "extern \"C\" fn start_routine<'thread, FF, TT>(args: *mut posix::void) -> *mut posix::void\nwhere\n    TT: Send + Debug + 'thread,\n    FF: FnOnce() -> TT + Send + 'thread,\n{",
          "purpose": "Extern C callback function for pthread_create with generic Rust closure"
        },
        {
          "file": "iceoryx2-pal/posix/src/qnx/signal.rs",
          "line": [28, 29, 30, 31],
          "code": "self.0.__sa_un._sa_handler = core::mem::transmute::<\n    usize,\n    core::option::Option<unsafe extern \"C\" fn(i32)>,\n>(handler);",
          "purpose": "Function pointer type for signal handler callback with C ABI"
        }
      ],
      "count": 630
    },
    "external_blocks": {
      "fls_section": "21.2",
      "fls_ids": [
        "fls_tmoh3y9oyqsy"
      ],
      "description": "External Blocks",
      "status": "demonstrated",
      "findings": {
        "platform_abstraction_layer": {
          "crate": "iceoryx2-pal/posix",
          "approach": "Unified POSIX API across platforms",
          "platforms": {
            "linux": {
              "path": "src/linux/",
              "notes": "Native Linux syscalls and glibc"
            },
            "macos": {
              "path": "src/macos/",
              "notes": "Darwin-specific APIs, libc++ linking for atomics"
            },
            "freebsd": {
              "path": "src/freebsd/",
              "notes": "FreeBSD-specific APIs and sysctl"
            },
            "windows": {
              "path": "src/windows/",
              "modules": 27,
              "notes": "Win32 API wrappers with POSIX-like interface"
            },
            "qnx": {
              "path": "src/qnx/",
              "notes": "QNX Neutrino RTOS support"
            },
            "libc_fallback": {
              "path": "src/libc/",
              "notes": "libc crate fallback for unsupported platforms"
            }
          },
          "binding_generation": {
            "tool": "bindgen",
            "header": "src/c/posix.h",
            "output": "posix_generated.rs"
          }
        }
      },
      "samples": [
        {
          "file": "iceoryx2-pal/posix/src/linux/select.rs",
          "line": [67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77],
          "code": "#[cfg_attr(target_os = \"linux\", link(name = \"c\"))]\nextern \"C\" {\n    pub(super) fn iceoryx2_cmsg_space(len: size_t) -> size_t;\n    pub(super) fn iceoryx2_cmsg_firsthdr(hdr: *const msghdr) -> *mut cmsghdr;\n    pub(super) fn iceoryx2_cmsg_nxthdr(hdr: *mut msghdr, sub: *mut cmsghdr) -> *mut cmsghdr;\n    pub(super) fn iceoryx2_cmsg_len(len: size_t) -> size_t;\n    pub(super) fn iceoryx2_cmsg_data(cmsg: *mut cmsghdr) -> *mut uchar;\n    pub(super) fn iceoryx2_fd_clr(fd: int, set: *mut fd_set);\n    pub(super) fn iceoryx2_fd_isset(fd: int, set: *const fd_set) -> int;\n    pub(super) fn iceoryx2_fd_set(fd: int, set: *mut fd_set);\n    pub(super) fn iceoryx2_fd_zero(set: *mut fd_set);\n}",
          "purpose": "External block declaring POSIX socket and fd_set helper functions from libc"
        },
        {
          "file": "iceoryx2-pal/posix/src/linux/pthread.rs",
          "line": [254, 255, 256, 257, 258, 259, 260],
          "code": "#[cfg_attr(target_os = \"linux\", link(name = \"pthread\"))]\nextern \"C\" {\n    pub(super) fn pthread_attr_setaffinity_np(\n        attr: *mut pthread_attr_t,\n        cpusetsize: size_t,\n        cpuset: *const native_cpu_set_t,\n    ) -> int;",
          "purpose": "External block for Linux pthread affinity functions with conditional linking"
        },
        {
          "file": "iceoryx2-pal/posix/src/freebsd/errno.rs",
          "line": [171, 172, 173, 174, 175],
          "code": "#[cfg_attr(target_os = \"freebsd\", link(name = \"c\"))]\nextern \"C\" {\n    pub(super) fn __error() -> *mut int;\n    pub(super) fn strerror_r(errnum: int, buf: *mut c_char, buflen: size_t) -> int;\n}",
          "purpose": "External block for FreeBSD errno access via __error() function"
        }
      ],
      "count": 11
    },
    "external_statics": {
      "fls_section": "21.4",
      "fls_ids": [
        "fls_s4yt19sptl7d"
      ],
      "description": "External Statics",
      "status": "demonstrated",
      "findings": {
        "description": "External statics are static items declared within an external block that are defined in external libraries. iceoryx2 uses external statics minimally, only in bare-metal examples.",
        "usage": "Limited to linker-defined symbols in bare-metal examples",
        "rationale": "Main codebase avoids extern statics - uses FFI function calls instead for better safety"
      },
      "samples": [
        {
          "file": "examples/nostd/bare-metal/rust/_common/src/global_allocator.rs",
          "line": [
            20,
            21,
            22
          ],
          "code": "extern \"C\" {\n    static _heap_start: u8;\n    static _heap_end: u8;\n}",
          "purpose": "Linker-defined symbols for heap memory bounds"
        }
      ],
      "count": 0,
      "samples_waiver": {
        "reason": "insufficient_patterns",
        "explanation": "Only 0 instance(s) found in codebase, fewer than 3 required samples",
        "approved_by": "automated",
        "date": "2025-12-30"
      }
    }
  },
  "design_patterns": {
    "c_api_layer": {
      "description": "NEW - Complete C API with consistent naming and error handling",
      "benefit": "Language-agnostic iceoryx2 access"
    },
    "union_with_manually_drop": {
      "description": "Discriminated unions with ManuallyDrop for explicit lifetime control",
      "benefit": "Safe FFI resource management without automatic Drop"
    },
    "ffi_macro_generation": {
      "description": "iceoryx2_ffi attribute macro generates FFI boilerplate",
      "benefit": "Reduces manual FFI code and ensures consistency"
    },
    "c_string_repr": {
      "description": "CStrRepr derive generates C-compatible string representations",
      "benefit": "Automatic C string conversion for enums"
    },
    "error_code_mapping": {
      "description": "IntoCInt trait maps Rust errors to C error codes",
      "benefit": "Idiomatic C error handling"
    },
    "bindgen_generation": {
      "description": "Automatic FFI binding generation from C headers",
      "benefit": "Type-safe bindings without manual declarations"
    },
    "platform_modules": {
      "description": "#[path] and #[cfg(target_os)] for platform selection",
      "benefit": "Single API surface, platform-specific implementations"
    },
    "repr_c_for_shm": {
      "description": "#[repr(C)] on all shared memory and FFI types",
      "benefit": "Guaranteed stable layout for IPC and C interop"
    }
  },
  "cross_chapter_references": {
    "chapter_13": "Attributes - #[no_mangle], #[link], #[link_name], #[repr(C)]",
    "chapter_15": "Ownership - ManuallyDrop for union destruction control",
    "chapter_18": "Program Structure - Platform-specific conditional compilation",
    "chapter_19": "Unsafety - All FFI calls and union access require unsafe",
    "chapter_20": "Macros - iceoryx2_ffi attribute and CStrRepr derive"
  }
}