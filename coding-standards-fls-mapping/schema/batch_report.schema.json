{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "batch_report.schema.json",
  "title": "Verification Batch Report",
  "description": "Schema for batch verification reports. Supports v1.0 (flat), v2.0 (per-context), v3.0 (per-context + ADD-6), and v4.0 (per-context + paragraph coverage) formats.",
  "type": "object",
  "required": ["schema_version", "batch_id", "session_id", "generated_date", "standard", "thresholds", "guidelines", "applicability_changes", "summary"],
  "properties": {
    "schema_version": {
      "type": "string",
      "enum": ["1.0", "2.0", "3.0", "4.0"],
      "description": "Schema version identifier"
    },
    "batch_id": {
      "type": "integer",
      "minimum": 1,
      "description": "Batch identifier (1-5)"
    },
    "session_id": {
      "type": "integer",
      "minimum": 1,
      "description": "Session identifier for this verification run"
    },
    "generated_date": {
      "type": "string",
      "format": "date",
      "description": "ISO 8601 date when the batch report was generated"
    },
    "standard": {
      "type": "string",
      "enum": ["misra_c", "misra_cpp", "cert_c", "cert_cpp"],
      "description": "The coding standard being verified"
    },
    "thresholds": {
      "type": "object",
      "required": ["section", "paragraph"],
      "properties": {
        "section": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Minimum similarity threshold for section matches"
        },
        "paragraph": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Minimum similarity threshold for paragraph matches"
        }
      }
    },
    "guidelines": {
      "type": "array",
      "description": "Array of guidelines to verify in this batch",
      "items": {
        "$ref": "#/$defs/guideline_entry"
      }
    },
    "applicability_changes": {
      "type": "array",
      "description": "Proposed applicability changes requiring human approval",
      "items": {
        "$ref": "#/$defs/applicability_change"
      }
    },
    "summary": {
      "type": "object",
      "required": ["total_guidelines", "verified_count"],
      "properties": {
        "total_guidelines": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of guidelines in this batch"
        },
        "verified_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of guidelines with completed verification decisions"
        },
        "all_rust_verified_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of guidelines with all_rust context verified (v2 only)"
        },
        "safe_rust_verified_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of guidelines with safe_rust context verified (v2 only)"
        },
        "applicability_changes_proposed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of proposed applicability changes"
        },
        "applicability_changes_approved": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of approved applicability changes"
        },
        "paragraph_coverage_warnings": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of guidelines with only section-level matches (no paragraphs) - v4.0 only"
        }
      }
    }
  },
  "$defs": {
    "misra_add6": {
      "type": "object",
      "description": "MISRA ADD-6 Rust applicability data for this guideline",
      "required": ["misra_category", "decidability", "scope", "rationale_codes"],
      "properties": {
        "misra_category": {
          "type": "string",
          "enum": ["Required", "Advisory", "Mandatory"],
          "description": "Original MISRA C category"
        },
        "decidability": {
          "type": "string",
          "enum": ["Decidable", "Undecidable", "n/a"],
          "description": "Whether static analysis can check this guideline"
        },
        "scope": {
          "type": "string",
          "enum": ["STU", "System", "n/a"],
          "description": "Analysis scope: STU (single translation unit) or System"
        },
        "rationale_codes": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["UB", "IDB", "CQ", "DC"]
          },
          "description": "Why this guideline exists: UB, IDB, CQ, DC"
        },
        "applicability_all_rust": {
          "type": "string",
          "enum": ["Yes", "No", "Partial"],
          "description": "MISRA's assessment: does this guideline apply to all Rust?"
        },
        "applicability_safe_rust": {
          "type": "string",
          "enum": ["Yes", "No", "Partial"],
          "description": "MISRA's assessment: does this guideline apply to safe Rust?"
        },
        "adjusted_category": {
          "type": "string",
          "enum": ["required", "advisory", "recommended", "disapplied", "implicit", "n_a"],
          "description": "MISRA's adjusted category for Rust"
        },
        "comment": {
          "type": ["string", "null"],
          "description": "MISRA's Rust-specific notes"
        }
      }
    },
    "guideline_entry": {
      "type": "object",
      "description": "A single guideline entry in the batch report",
      "required": ["guideline_id", "guideline_title", "current_state", "verification_decision"],
      "properties": {
        "guideline_id": {
          "type": "string",
          "description": "MISRA guideline ID (e.g., 'Rule 10.1', 'Dir 4.1')"
        },
        "guideline_title": {
          "type": "string",
          "description": "Title/summary of the guideline"
        },
        "misra_add6": {
          "$ref": "#/$defs/misra_add6",
          "description": "MISRA ADD-6 Rust applicability data (required for v3.0 batch reports)"
        },
        "current_state": {
          "type": "object",
          "description": "Current state of the guideline mapping from misra_c_to_fls.json",
          "properties": {
            "schema_version": { "type": ["string", "null"] },
            "applicability_all_rust": { "type": ["string", "null"] },
            "applicability_safe_rust": { "type": ["string", "null"] },
            "confidence": { "type": ["string", "null"] },
            "fls_rationale_type": { "type": ["string", "null"] },
            "accepted_matches": { "type": "array" },
            "rejected_matches": { "type": "array" },
            "notes": { "type": ["string", "null"] },
            "all_rust": { "type": "object" },
            "safe_rust": { "type": "object" },
            "misra_add6": { "$ref": "#/$defs/misra_add6" }
          }
        },
        "rationale": {
          "type": ["string", "null"],
          "description": "Extracted MISRA rationale text"
        },
        "similarity_data": {
          "type": "object",
          "description": "Similarity search results for this guideline"
        },
        "fls_content": {
          "type": "object",
          "description": "Extracted FLS content for matched sections"
        },
        "verification_decision": {
          "oneOf": [
            { "$ref": "#/$defs/verification_decision_v1" },
            { "$ref": "#/$defs/verification_decision_v2" },
            { "type": "null" }
          ]
        }
      }
    },
    "verification_decision_v1": {
      "type": "object",
      "description": "v1.0 format: Flat verification decision structure",
      "properties": {
        "decision": {
          "type": ["string", "null"],
          "enum": ["accept_with_modifications", "accept_no_matches", "accept_existing", "reject", null],
          "description": "The verification decision type"
        },
        "confidence": {
          "type": ["string", "null"],
          "enum": ["high", "medium", "low", null],
          "description": "Confidence level in the verification decision"
        },
        "fls_rationale_type": {
          "type": ["string", "null"],
          "enum": ["direct_mapping", "rust_alternative", "rust_prevents", "no_equivalent", "partial_mapping", null],
          "description": "Type of relationship between the guideline and FLS"
        },
        "accepted_matches": {
          "type": "array",
          "items": { "$ref": "#/$defs/fls_match" }
        },
        "rejected_matches": {
          "type": "array",
          "items": { "$ref": "#/$defs/fls_match" }
        },
        "notes": {
          "type": ["string", "null"]
        },
        "proposed_applicability_change": {
          "type": ["object", "null"],
          "$ref": "#/$defs/proposed_change"
        },
        "search_tools_used": {
          "type": ["array", "null"],
          "items": { "$ref": "#/$defs/search_tool_usage" }
        }
      }
    },
    "verification_decision_v2": {
      "type": "object",
      "description": "v2.0 format: Per-context verification decision structure",
      "required": ["all_rust", "safe_rust"],
      "properties": {
        "all_rust": {
          "$ref": "#/$defs/context_decision",
          "description": "Verification decision for ALL Rust code (including unsafe)"
        },
        "safe_rust": {
          "$ref": "#/$defs/context_decision",
          "description": "Verification decision for SAFE Rust code only"
        }
      }
    },
    "context_decision": {
      "type": "object",
      "description": "Verification decision for a specific Rust context",
      "properties": {
        "decision": {
          "type": ["string", "null"],
          "enum": ["accept_with_modifications", "accept_no_matches", "accept_existing", "reject", "pending", null],
          "description": "The verification decision type"
        },
        "applicability": {
          "type": ["string", "null"],
          "enum": ["yes", "no", "partial", null],
          "description": "Whether the MISRA guideline applies in this context"
        },
        "adjusted_category": {
          "type": ["string", "null"],
          "enum": ["required", "advisory", "recommended", "disapplied", "implicit", "n_a", null],
          "description": "MISRA's adjusted category for Rust"
        },
        "rationale_type": {
          "type": ["string", "null"],
          "enum": ["direct_mapping", "partial_mapping", "rust_alternative", "rust_prevents", "no_equivalent", null],
          "description": "Type of relationship between the guideline and FLS"
        },
        "confidence": {
          "type": ["string", "null"],
          "enum": ["high", "medium", "low", null],
          "description": "Confidence level in the verification decision"
        },
        "accepted_matches": {
          "type": "array",
          "items": { "$ref": "#/$defs/fls_match" }
        },
        "rejected_matches": {
          "type": "array",
          "items": { "$ref": "#/$defs/fls_match" }
        },
        "search_tools_used": {
          "type": ["array", "null"],
          "items": { "$ref": "#/$defs/search_tool_usage" }
        },
        "notes": {
          "type": ["string", "null"]
        },
        "paragraph_match_count": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Count of paragraph-level matches (category != 0) - v4.0 only"
        },
        "section_match_count": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Count of section-level matches (category = 0) - v4.0 only"
        },
        "paragraph_level_waiver": {
          "type": ["string", "null"],
          "description": "If no paragraph matches, explains why - v4.0 only"
        }
      }
    },
    "fls_match": {
      "type": "object",
      "required": ["fls_id", "category", "score", "reason"],
      "properties": {
        "fls_id": {
          "type": "string",
          "pattern": "^fls_[a-zA-Z0-9]+$",
          "description": "FLS identifier for the matched section or paragraph"
        },
        "category": {
          "type": "integer",
          "enum": [0, -1, -2, -3, -4, -5, -6, -7, -8],
          "description": "Category code"
        },
        "fls_title": {
          "type": "string",
          "description": "Human-readable title of the FLS section"
        },
        "score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Similarity score (0-1) or 1.0 for manually added matches"
        },
        "reason": {
          "type": "string",
          "description": "Justification for accepting/rejecting this match"
        }
      }
    },
    "applicability_change": {
      "type": "object",
      "required": ["guideline_id", "context", "field", "current_value", "proposed_value", "rationale"],
      "properties": {
        "guideline_id": {
          "type": "string",
          "description": "The guideline ID for which this change is proposed"
        },
        "context": {
          "type": "string",
          "enum": ["all_rust", "safe_rust", "shared"],
          "description": "Which context this change applies to (shared for v1 compatibility)"
        },
        "field": {
          "type": "string",
          "enum": ["applicability", "adjusted_category", "rationale_type", "applicability_all_rust", "applicability_safe_rust", "fls_rationale_type"],
          "description": "The field to be changed"
        },
        "current_value": {
          "type": "string",
          "description": "Current value of the field"
        },
        "proposed_value": {
          "type": "string",
          "description": "Proposed new value"
        },
        "rationale": {
          "type": "string",
          "description": "Justification for the proposed change"
        },
        "approved": {
          "type": ["boolean", "null"],
          "description": "Whether the change was approved by human reviewer (null = pending)"
        }
      }
    },
    "proposed_change": {
      "type": "object",
      "required": ["field", "current_value", "proposed_value", "rationale"],
      "properties": {
        "field": {
          "type": "string",
          "enum": ["applicability_all_rust", "applicability_safe_rust", "fls_rationale_type"]
        },
        "current_value": { "type": "string" },
        "proposed_value": { "type": "string" },
        "rationale": { "type": "string" }
      }
    },
    "search_tool_usage": {
      "type": "object",
      "description": "Record of a search tool used during verification",
      "required": ["tool", "query"],
      "properties": {
        "search_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for this search execution (UUID4)"
        },
        "tool": {
          "type": "string",
          "enum": ["search-fls", "search-fls-deep", "recompute-similarity", "read-fls-chapter", "grep-fls"],
          "description": "The search tool used during verification"
        },
        "query": {
          "type": "string",
          "description": "The search query, guideline ID, or file path used"
        },
        "result_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of results returned (optional)"
        }
      }
    }
  }
}
